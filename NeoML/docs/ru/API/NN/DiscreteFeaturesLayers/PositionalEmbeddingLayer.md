# Класс CPositionalEmbeddingLayer

<!-- TOC -->

- [Класс CPositionalEmbeddingLayer](#класс-cpositionalembeddinglayer)
    - [Настройки](#настройки)
    - [Обучаемые параметры](#обучаемые-параметры)
        - [Типы векторов](#типы-векторов)
    - [Входы](#входы)
    - [Выходы](#выходы)

<!-- /TOC -->

Класс реализует слой, сопоставляющий вектора разным позициям в последовательности и, в некоторых случаях, обучающий их.

## Настройки

### Типы векторов

```c++
// Тип векторов
enum TPositionalEmbeddingType {
    // Обучаемые, прибавляемые к входам Y = X + embedding
    PET_LearnableAddition = 0,
    // Обучаемые, с линейным преобразованием. Y = a * X + b
    PET_LearnableMultAddition,
    // Необучаемые (используются в трансформерах https://arxiv.org/abs/1807.03819).
    // Дополнительное ограничение на размер входа: Depth == Height == Width == 1.
    PET_Transformers,

    PET_EnumCount
};

void SetType( TPositionalEmbeddingType newType );
```

Тип векторов.

## Обучаемые параметры

Если `GetType() == PET_Transformers`, то слой не имеет обучаемых параметров и результат считается по формуле

```c++
result[i][j][k] = input[i][j][k] + sin( j / pow( 10000, ( k / vectorSize ) ) )
```

где:

- `i` - индекс последовательности в батче (от `0` до `BatchWidth - 1`)
- `j` - позиция вектора в последовательности (от `0` до `ListSize - 1`)
- `vectorSize` - длина векторов (`Height * Width * Depth * Channels`)
- `k` - индекс элемента в векторе (от `0` до `vectorSize - 1`)

Если `GetType() == PET_LearnableAddition` то слой обучает один набор векторов (`B`) и результат считается по формуле:

```c++
result[i][j] = input[i][j] + B[j]
```

где:

- `i` - индекс последовательности в батче (от `0` до `BatchWidth - 1`)
- `j` - позиция вектора в последовательности (от `0` до `ListSize - 1`).

Если `GetType() == PET_LearnableMultAddition` то слой обучает два набора векторов (`A` и `B`) и результат считает по формуле:

```c++
result[i][j] = ( input[i][j] * A[j] ) + B[j]
```

где:

- `i` - индекс последовательности в батче (от `0` до `BatchWidth - 1`)
- `j` - позиция вектора в последовательности (от `0` до `ListSize - 1`)
- `*` - поэлементное произведение двух векторов.

## Входы

На единственный вход подается блоб, который содержит набор последовательностей векторов следующего размера

- `BatchLength` должен быть равен `1`;
- `BatchWidth` - количество последовательностей в наборе;
- `ListSize` - длина последовательностей;
- `Height * Width * Depth * Channels` - длина векторов в наборе;
  - если `GetType() == PET_Transformers`, то `Height`, `Width` и `Depth` должны быть равны `1`.

## Выходы

Единственный выход слоя содержит блоб с результатами того же размера, что и входной блоб.
